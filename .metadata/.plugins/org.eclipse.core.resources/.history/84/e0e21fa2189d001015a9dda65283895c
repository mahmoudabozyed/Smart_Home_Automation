#include "MCAL/ADC/ADC.h"
#include "HAL/LCD/LCD.h"
#include "MCAL/PWM/PWM.h"
#include "HAL/DCMotor/DCMotor.h"
#include "HAL/LDR/LDR.h"
#include "HAL/LM35/LM35.h"
#include "HAL/Flame_sensor/Flame.h"
#include "HAL/LED/LED.h"
#include "MCAL/GPIO/common_macros.h"
#include "MCAL/GPIO/std_type.h"

#include <avr/io.h>
#include <util/delay.h>

int main(void) {
	uint16 light;
	uint16 data;
	uint8 temp;

	ADC_init();
	FlameSensor_init();
	LCD_init();
	DcMotor_Init();
	Buzzer_init();

	LCD_displayStringRowColumn(0, 3, "FAN is ");
	LCD_displayStringRowColumn(1, 0, "Temp= ");
	LCD_displayStringRowColumn(1, 8, "LDR= ");

	while (1) {
		light = LDR_getLightIntensity();
		if (light == 1) {
			light = 0;
		}

		data = ADC_readChannel(1);
		temp = LM35_getTemperature();

		LCD_moveCursur(1, 5);
		LCD_itos(temp);
		LCD_displayString(" ");

		LCD_moveCursur(1, 12);
		LCD_itos(light);
		LCD_displayString("% ");

		/* ================= Fan Control ================= */
		if (temp >= 40) {
			DcMotor_Rotate(CW, 100);
			LCD_displayStringRowColumn(0, 10, "ON ");
		} else if (temp >= 35) {
			DcMotor_Rotate(CW, 75);
			LCD_displayStringRowColumn(0, 10, "ON ");
		} else if (temp >= 30) {
			DcMotor_Rotate(CW, 50);
			LCD_displayStringRowColumn(0, 10, "ON ");
		} else if (temp >= 25) {
			DcMotor_Rotate(CW, 25);
			LCD_displayStringRowColumn(0, 10, "ON ");
		} else {
			DcMotor_Rotate(Stop, 0);
			LCD_displayStringRowColumn(0, 10, "OFF");
		}

		/* ================= LED Control ================= */
		if (light < 15) {
			LED_on(RED_LED);
			LED_on(GREEN_LED);
			LED_on(BLUE_LED);
		} else if (light <= 50) {
			LED_on(RED_LED);
			LED_on(GREEN_LED);
			LED_off(BLUE_LED);
		} else if (light <= 70) {
			LED_on(RED_LED);
			LED_off(GREEN_LED);
			LED_off(BLUE_LED);
		} else {
			LED_off(RED_LED);
			LED_off(GREEN_LED);
			LED_off(BLUE_LED);
		}

		/* ================= Flame Detection ================= */
		if (FlameSensor_getValue() == HIGH) {
			Buzzer_on();
			LCD_clearScreen();
			LCD_displayStringRowColumn(0, 3, "ALERT!");
			LCD_displayStringRowColumn(1, 0, "Critical Fire!");
		} else {
			Buzzer_off();

			LCD_clearScreen();
			LCD_displayStringRowColumn(0, 3, "FAN is ");
			LCD_displayStringRowColumn(1, 0, "Temp= ");
			LCD_displayStringRowColumn(1, 8, "LDR= ");
		}
	}
}
