#include "MCAL/ADC/ADC.h"
#include "HAL/LCD/LCD.h"
#include "MCAL/PWM/PWM.h"
#include "HAL/DCMotor/DCMotor.h"
#include "HAL/LDR/LDR.h"
#include "HAL/LM35/LM35.h"
#include "HAL/Flame_sensor/Flame.h"
#include "HAL/LED/LED.h"
#include "MCAL/GPIO/common_macros.h"
#include "MCAL/GPIO/std_type.h"

#include <avr/io.h>
#include <util/delay.h>

int main(void)
{
    uint16 temp;
    uint16 light;
    uint8 flame;

    /* ===================== Initialization ===================== */
    ADC_init();
    LCD_init();
    PWM_Timer0_Start();
    DcMotor_Init();
    LEDS_init();
    FlameSensor_init();
    Buzzer_init();

    LCD_displayStringRowColumn(0,0,"Smart Home Ready");

    _delay_ms(1000);
    LCD_clearScreen();

    while(1)
    {
        /* ----------- قراءة الحساسات ----------- */
        temp = LM35_getTemperature();
        light = LDR_getLightIntensity();
        flame = FlameSensor_getValue();

        /* ----------- التحكم في المروحة ----------- */
        if(temp >= 40)
        {
            DcMotor_Rotate(CW, 100);  // سرعة 100%
            LCD_displayStringRowColumn(0,0,"FAN is ON  ");
        }
        else if(temp >= 35)
        {
            DcMotor_Rotate(CW, 75);
            LCD_displayStringRowColumn(0,0,"FAN is ON  ");
        }
        else if(temp >= 30)
        {
            DcMotor_Rotate(CW, 50);
            LCD_displayStringRowColumn(0,0,"FAN is ON  ");
        }
        else if(temp >= 25)
        {
            DcMotor_Rotate(CW, 25);
            LCD_displayStringRowColumn(0,0,"FAN is ON  ");
        }
        else
        {
            DcMotor_Rotate(Stop, 0);
            LCD_displayStringRowColumn(0,0,"FAN is OFF ");
        }

        /* ----------- التحكم في الإضاءة ----------- */
        if(light < 15)
        {
            LED_on(RED_LED);
            LED_on(GREEN_LED);
            LED_on(BLUE_LED);
        }
        else if(light < 50)
        {
            LED_on(RED_LED);
            LED_on(GREEN_LED);
            LED_off(BLUE_LED);
        }
        else if(light < 70)
        {
            LED_on(RED_LED);
            LED_off(GREEN_LED);
            LED_off(BLUE_LED);
        }
        else
        {
            LED_off(RED_LED);
            LED_off(GREEN_LED);
            LED_off(BLUE_LED);
        }

        /* ----------- حساس اللهب ----------- */
        if(flame)
        {
            LCD_clearScreen();
            LCD_displayStringRowColumn(0,0,"Critical Alert!");
            Buzzer_on();
        }
        else
        {
            Buzzer_off();
        }

        /* ----------- عرض البيانات على LCD ----------- */
        LCD_moveCursor(1,0);
        LCD_displayString("Temp = ");
        LCD_intgerToString(temp);
        LCD_displayCharacter('C');

        LCD_displayString(" LDR = ");
        LCD_intgerToString(light);
        LCD_displayCharacter('%');

        _delay_ms(500);
    }
}
